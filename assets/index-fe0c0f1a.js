var I=Object.defineProperty;var R=(l,t,e)=>t in l?I(l,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):l[t]=e;var h=(l,t,e)=>(R(l,typeof t!="symbol"?t+"":t,e),e);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))s(r);new MutationObserver(r=>{for(const n of r)if(n.type==="childList")for(const a of n.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&s(a)}).observe(document,{childList:!0,subtree:!0});function e(r){const n={};return r.integrity&&(n.integrity=r.integrity),r.referrerPolicy&&(n.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?n.credentials="include":r.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function s(r){if(r.ep)return;r.ep=!0;const n=e(r);fetch(r.href,n)}})();class w{constructor(t){h(this,"pos");this.pos=t}}class i{constructor(t,e){h(this,"x");h(this,"y");this.x=t,this.y=e}add(t,e){return t instanceof i?(this.x+=t.x,this.y+=t.y):e?(this.x+=t,this.y+=e):(this.x+=t,this.y+=t),this}static add(t,e){return new i(t.x+e.x,t.y+e.y)}mult(t,e){return t instanceof i?(this.x*=t.x,this.y*=t.y):e?(this.x*=t,this.y*=e):(this.x*=t,this.y*=t),this}static mult(t,e){return new i(t.x*e.x,t.y*e.y)}sub(t,e){return t instanceof i?(this.x-=t.x,this.y-=t.y):e?(this.x-=t,this.y-=e):(this.x-=t,this.y-=t),this}static sub(t,e){return new i(t.x-e.x,t.y-e.y)}div(t,e){return t instanceof i?(this.x/=t.x,this.y/=t.y):e?(this.x/=t,this.y/=e):(this.x/=t,this.y/=t),this}static div(t,e){return new i(t.x/e.x,t.y/e.y)}set(t,e){return t instanceof i?(this.x=t.x,this.y=t.y):e?(this.x=t,this.y=e):(this.x=t,this.y=t),this}mag(){return Math.sqrt(this.x*this.x+this.y*this.y)}static mag(t){return Math.sqrt(t.x*t.x+t.y*t.y)}magSq(){return this.x*this.x+this.y*this.y}static magSq(t){return t.x*t.x+t.y*t.y}setMag(t){let e=this.mag();return this.x*=t/e,this.y*=t/e,this}normalize(){return this.setMag(1),this}limit(t){return this.mag()>t&&this.setMag(t),this}heading(){return Math.atan2(this.y,this.x)}rotate(t){let e=Math.cos(t),s=Math.sin(t),r=e*this.x-s*this.y,n=e*this.y+s*this.x;return this.x=r,this.y=n,this}dot(t){return t.x*this.x+t.y*this.y}static dot(t,e){return t.x*e.x+t.y*e.y}cross(t){return this.x*t.y-this.y*t.x}static cross(t,e){return t.x*e.y-t.y*e.x}dist(t){return Math.sqrt(Math.pow(this.x-t.x,2)+Math.pow(this.y-t.y,2))}static dist(t,e){return Math.sqrt(Math.pow(e.x-t.x,2)+Math.pow(e.y-t.y,2))}lerp(t,e){let s=t.x-this.x,r=t.y-this.y;return this.x+=e*s,this.y+=e*r,this}copy(){return new i(this.x,this.y)}}class P{constructor(t,e){h(this,"origin");h(this,"dir");h(this,"path");this.origin=t,this.dir=e.copy(),this.path=[this.origin]}trace(t){this.path=[this.origin];let e=this.path[0],s=this.dir.copy(),r=null;for(let n=0;n<500;n++){let a=null,o=null,d=1/0;for(let c=0;c<t.length;c++){let p=t[c].intersects(e,s);if(!p)continue;let x=i.sub(p,e).magSq();x<d&&c!==r&&(a=p,d=x,o=c)}if(a&&o!==null)this.path.push(a),e=a,s=t[o].handle(a,s).copy(),r=o;else break}this.path.push(e.copy().add(s.mult(2e3)))}render(t){t.beginPath(),t.moveTo(this.origin.x,this.origin.y);for(let e of this.path)t.lineTo(e.x,e.y);t.strokeStyle="rgba(255, 255, 255, 0.4)",t.stroke()}}class S extends w{constructor(e){super(e);h(this,"size");h(this,"numRays");h(this,"lightRays");this.size=100,this.numRays=50,this.lightRays=[];for(let s=-this.size/2;s<=this.size/2;s+=this.size/this.numRays)this.lightRays.push(new P(i.add(this.pos,new i(0,s)),new i(1,0)))}addToWorld(e){for(let s of this.lightRays)e.addLightRay(s)}handleClick(e){return!1}render(e){for(let s of this.lightRays)s.render(e)}}function z(l,t,e,s){let r=i.sub(t,l),n=i.sub(l,e),a=i.cross(s,r),o=i.cross(n,r)/a,d=i.cross(n,s)/a;return o>=0&&d>=0&&d<=1?i.add(e,s.mult(o)):null}function q(l,t,e,s=.1){let r=i.sub(l,e).mag(),n=i.sub(t,e).mag(),a=i.sub(t,l).mag();return Math.abs(r+n-a)<s}class E{constructor(t,e){h(this,"v1");h(this,"v2");h(this,"normal",new i(0,0));this.v1=t,this.v2=e,this.calculateNormal()}handle(t,e){throw Error("Not implemented")}calculateNormal(){this.normal=i.sub(this.v2,this.v1).rotate(Math.PI/2).normalize()}setVertices(t,e){this.v1=t.copy(),this.v2=e.copy(),this.calculateNormal()}intersects(t,e){return z(this.v1.copy(),this.v2.copy(),t.copy(),e.copy())}intersectsPoint(t,e=.1){return q(this.v1.copy(),this.v2.copy(),t.copy(),e)}render(t){t.strokeStyle="white",t.lineWidth=2,t.beginPath(),t.moveTo(this.v1.x,this.v1.y),t.lineTo(this.v2.x,this.v2.y),t.stroke();const e=i.add(this.v1,this.v2).mult(.5);t.strokeStyle="red",t.lineWidth=1,t.beginPath(),t.moveTo(e.x,e.y),t.lineTo(e.x+this.normal.x*50,e.y+this.normal.y*50),t.stroke()}}class g extends E{constructor(e,s,r){super(e,s);h(this,"refractiveIndex");h(this,"criticalAngle");this.refractiveIndex=r,this.criticalAngle=Math.asin(1/this.refractiveIndex)}handle(e,s){let r=Math.atan2(s.y,s.x)-Math.atan2(this.normal.y,this.normal.x);if(r>Math.PI/2||r<-Math.PI/2){let n=Math.PI-r,a=Math.asin(Math.sin(n)/this.refractiveIndex),o=n-a;return s.copy().rotate(o)}else{let n=r;if(n>this.criticalAngle||n<-this.criticalAngle)return i.sub(s,this.normal.copy().mult(2*i.dot(s,this.normal)/this.normal.magSq()));let a=Math.asin(Math.sin(n)*this.refractiveIndex),o=n-a;return s.copy().rotate(-o)}}}class T{constructor(t){h(this,"pos");h(this,"radius");h(this,"state");this.pos=t,this.radius=6,this.state=0}update(t,e){e||(this.state=0),this.state===2?(this.pos=t.copy(),e||(this.state=0)):this.state===1?e&&(this.state=2):t.dist(this.pos)<this.radius?this.state=1:this.state=0}render(t){let e=this.state===1?this.radius*1.5:this.radius;t.beginPath(),t.arc(this.pos.x,this.pos.y,e,0,2*Math.PI),t.fillStyle="yellow",t.fill()}}const u=[new i(0,-Math.sqrt(3)/3),new i(.5,Math.sqrt(3)/6),new i(-.5,Math.sqrt(3)/6)];class L extends w{constructor(e){super(e);h(this,"angle");h(this,"size");h(this,"refractiveIndex");h(this,"surfaces");h(this,"posDrag");this.size=200,this.refractiveIndex=1.5,this.angle=0,this.posDrag=new T(e);let s=i.add(this.pos,u[0].copy().mult(this.size).rotate(this.angle)),r=i.add(this.pos,u[1].copy().mult(this.size).rotate(this.angle)),n=i.add(this.pos,u[2].copy().mult(this.size).rotate(this.angle));this.surfaces=[new g(r,s,this.refractiveIndex),new g(n,r,this.refractiveIndex),new g(s,n,this.refractiveIndex)],this.recalculateVertices()}addToWorld(e){for(let s of this.surfaces)e.addSurface(s)}rotate(e){this.angle+=e,this.recalculateVertices()}recalculateVertices(){let e=i.add(this.pos,u[0].copy().mult(this.size).rotate(this.angle)),s=i.add(this.pos,u[1].copy().mult(this.size).rotate(this.angle)),r=i.add(this.pos,u[2].copy().mult(this.size).rotate(this.angle));this.surfaces[0].setVertices(s,e),this.surfaces[1].setVertices(r,s),this.surfaces[2].setVertices(e,r)}handleClick(e){for(let s of this.surfaces)if(s.intersectsPoint(e,10))return console.log("YEE"),!0;return!1}render(e){for(let s of this.surfaces)s.render(e);this.posDrag.render(e)}}class b{constructor(){h(this,"surfaces",[]);h(this,"lightRays",[]);h(this,"entities",[])}addSurface(t){this.surfaces.push(t)}addLightRay(t){this.lightRays.push(t)}addEntity(t){this.entities.push(t),t.addToWorld(this)}update(){for(let t of this.lightRays)t.trace(this.surfaces)}handleClick(t){for(let e of this.entities)e.handleClick(t)}render(t){for(let e of this.lightRays)e.render(t);for(let e of this.entities)e.render(t)}}const y=document.getElementById("display"),m=y.getContext("2d");y.width=window.innerWidth;y.height=window.innerHeight;const f=new b,v=new L(new i(600,300));f.addEntity(v);f.addEntity(new S(new i(300,300)));window.addEventListener("click",l=>{f.handleClick(new i(l.clientX,l.clientY))});function M(){requestAnimationFrame(M),m.fillStyle="black",m.fillRect(0,0,y.width,y.height),v.rotate(.001),f.update(),f.render(m)}M();
