var S=Object.defineProperty;var O=(a,t,e)=>t in a?S(a,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):a[t]=e;var r=(a,t,e)=>(O(a,typeof t!="symbol"?t+"":t,e),e);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const h of i)if(h.type==="childList")for(const o of h.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&s(o)}).observe(document,{childList:!0,subtree:!0});function e(i){const h={};return i.integrity&&(h.integrity=i.integrity),i.referrerPolicy&&(h.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?h.credentials="include":i.crossOrigin==="anonymous"?h.credentials="omit":h.credentials="same-origin",h}function s(i){if(i.ep)return;i.ep=!0;const h=e(i);fetch(i.href,h)}})();const c=class{constructor(t,e){r(this,"x");r(this,"y");this.x=t,this.y=e}add(t,e){return t instanceof c?(this.x+=t.x,this.y+=t.y):e?(this.x+=t,this.y+=e):(this.x+=t,this.y+=t),this}static add(t,e){return new c(t.x+e.x,t.y+e.y)}mult(t,e){return t instanceof c?(this.x*=t.x,this.y*=t.y):e?(this.x*=t,this.y*=e):(this.x*=t,this.y*=t),this}static mult(t,e){return e instanceof c?new c(t.x*e.x,t.y*e.y):new c(t.x*e,t.y*e)}sub(t,e){return t instanceof c?(this.x-=t.x,this.y-=t.y):e?(this.x-=t,this.y-=e):(this.x-=t,this.y-=t),this}static sub(t,e){return new c(t.x-e.x,t.y-e.y)}div(t,e){return t instanceof c?(this.x/=t.x,this.y/=t.y):e?(this.x/=t,this.y/=e):(this.x/=t,this.y/=t),this}static div(t,e){return new c(t.x/e.x,t.y/e.y)}set(t,e){return t instanceof c?(this.x=t.x,this.y=t.y):e?(this.x=t,this.y=e):(this.x=t,this.y=t),this}mag(){return Math.sqrt(this.x*this.x+this.y*this.y)}static mag(t){return Math.sqrt(t.x*t.x+t.y*t.y)}magSq(){return this.x*this.x+this.y*this.y}static magSq(t){return t.x*t.x+t.y*t.y}setMag(t){let e=this.mag();return this.x*=t/e,this.y*=t/e,this}normalize(){return this.setMag(1),this}limit(t){return this.mag()>t&&this.setMag(t),this}heading(){return Math.atan2(this.y,this.x)}rotate(t){let e=Math.cos(t),s=Math.sin(t),i=e*this.x-s*this.y,h=e*this.y+s*this.x;return this.x=i,this.y=h,this}rotateAboutAxis(t,e){return this.sub(e).rotate(t).add(e),this}dot(t){return t.x*this.x+t.y*this.y}static dot(t,e){return t.x*e.x+t.y*e.y}cross(t){return this.x*t.y-this.y*t.x}static cross(t,e){return t.x*e.y-t.y*e.x}dist(t){return Math.sqrt(Math.pow(this.x-t.x,2)+Math.pow(this.y-t.y,2))}static dist(t,e){return Math.sqrt(Math.pow(e.x-t.x,2)+Math.pow(e.y-t.y,2))}lerp(t,e){let s=t.x-this.x,i=t.y-this.y;return this.x+=e*s,this.y+=e*i,this}static angleBetween(t,e){return Math.atan2(t.x*e.y-t.y*e.x,t.x*e.x+t.y*e.y)}copy(){return new c(this.x,this.y)}};let n=c;r(n,"zero",()=>new c(0,0)),r(n,"up",()=>new c(0,-1)),r(n,"down",()=>new c(0,1)),r(n,"left",()=>new c(-1,0)),r(n,"right",()=>new c(1,0));function k(a,t){return n.sub(a,t.copy().mult(2*n.dot(a,t)/t.magSq()))}function E(a,t,e,s){let i=Math.atan2(a.y,a.x)-Math.atan2(t.y,t.x);if(i>Math.PI&&(i=-(Math.PI*2-i)),i<-Math.PI&&(i=Math.PI*2+i),i>Math.PI/2||i<-Math.PI/2){let h=Math.PI-i,o=Math.asin(Math.sin(h)/e),u=h-o;return a.copy().rotate(u)}else{let h=i;if(h>s||h<-s)return k(a,t);let o=Math.asin(Math.sin(h)*e),u=h-o;return a.copy().rotate(-u)}}function C(a,t,e,s){let i=n.sub(t,a),h=n.sub(a,e),o=n.cross(s,i),u=n.cross(h,i)/o,d=n.cross(h,s)/o;return u>=0&&d>=0&&d<=1?n.add(e,s.mult(u)):null}function R(a,t,e,s=.1){let i=n.sub(a,e).mag(),h=n.sub(t,e).mag(),o=n.sub(t,a).mag();return Math.abs(i+h-o)<s}function L(a,t,e){let s=n.sub(e,a),i=n.dot(s,t)/t.magSq();return n.add(a,t.mult(i))}class x{constructor(t,e){r(this,"start");r(this,"end");this.start=t,this.end=e}has(t){return!(t.x<this.start.x||t.x>this.end.x||t.y<this.start.y||t.y>this.end.y)}setMinSize(t){if(Math.abs(this.start.x-this.end.x)<t){let e=t-Math.abs(this.start.x-this.end.x);this.start.x-=e/2,this.end.x+=e/2}if(Math.abs(this.start.y-this.end.y)<t){let e=t-Math.abs(this.start.y-this.end.y);this.start.y-=e/2,this.end.y+=e/2}}render(t,e="#8424b9",s=1){t.strokeStyle=e,t.lineWidth=s,t.strokeRect(this.start.x,this.start.y,this.end.x-this.start.x,this.end.y-this.start.y)}static fromPoints(t){let e=t[0].copy(),s=t[0].copy();for(let i of t)i.x<e.x?e.x=i.x:i.x>s.x&&(s.x=i.x),i.y<e.y?e.y=i.y:i.y>s.y&&(s.y=i.y);return new x(e,s)}static fromAABBs(t){const e=[];for(let s of t)e.push(s.start,s.end);return x.fromPoints(e)}}class P{}class N extends P{constructor(e,s,i,h){super();r(this,"center");r(this,"radius");r(this,"facing");r(this,"span");r(this,"canIntersectTwice",!0);this.center=e,this.radius=s,this.facing=i,this.span=h}intersects(e,s){let i=L(e.copy(),s.copy(),this.center),h=n.sub(i,this.center).magSq();if(h>this.radius*this.radius)return null;let o=Math.sqrt(this.radius*this.radius-h);if(n.sub(e,i).magSq()>o*o){let d=n.sub(i,s.copy().normalize().mult(o));if(!(Math.abs(n.angleBetween(n.sub(d,e),s))>.2)){let f=n.sub(d,this.center);if(Math.abs(n.angleBetween(f,this.facing))<=this.span/2&&e.dist(d)>.01)return d}}let u=n.add(i,s.copy().normalize().mult(o));if(!(Math.abs(n.angleBetween(n.sub(u,e),s))>.2)){let d=n.sub(u,this.center);if(Math.abs(n.angleBetween(d,this.facing))<=this.span/2&&e.dist(u)>.01)return u}return null}translate(e){this.center.add(e)}rotateAboutAxis(e,s){this.center.rotateAboutAxis(e,s),this.facing.rotate(e)}calculateAABB(){const e=[n.up(),n.down(),n.left(),n.right()],s=[];for(const i of e)Math.abs(n.angleBetween(i,this.facing))<this.span/2&&s.push(n.add(this.center,n.mult(i,this.radius)));return s.push(n.add(this.center,n.mult(this.facing.copy().rotate(this.span/2),this.radius))),s.push(n.add(this.center,n.mult(this.facing.copy().rotate(-this.span/2),this.radius))),x.fromPoints(s)}render(e,s="#ffffff"){let i=this.facing.heading()-this.span/2,h=this.facing.heading()+this.span/2;e.beginPath(),e.strokeStyle=s,e.lineWidth=2,e.arc(this.center.x,this.center.y,this.radius,i,h),e.stroke()}}class v extends N{constructor(e,s,i,h,o,u=1){super(e,s,i,h);r(this,"refractiveIndex");r(this,"criticalAngle");r(this,"normal");this.refractiveIndex=o,this.criticalAngle=Math.asin(1/this.refractiveIndex),this.normal=u}handle(e,s){let i=n.sub(e,this.center).normalize().mult(this.normal);return E(s,i,this.refractiveIndex,this.criticalAngle)}}class q extends P{constructor(e,s){super();r(this,"v1");r(this,"v2");r(this,"normal",new n(0,0));r(this,"canIntersectTwice",!1);this.v1=e,this.v2=s,this.calculateNormal()}calculateNormal(){this.normal=n.sub(this.v2,this.v1).rotate(Math.PI/2).normalize()}setVertices(e,s){this.v1=e.copy(),this.v2=s.copy(),this.calculateNormal()}translate(e){this.v1.add(e),this.v2.add(e),this.calculateNormal()}rotateAboutAxis(e,s){this.v1.rotateAboutAxis(e,s),this.v2.rotateAboutAxis(e,s),this.calculateNormal()}intersects(e,s){return C(this.v1.copy(),this.v2.copy(),e.copy(),s.copy())}intersectsPoint(e,s=.1){return R(this.v1.copy(),this.v2.copy(),e.copy(),s)}calculateAABB(){return x.fromPoints([this.v1,this.v2])}render(e,s="#ffffff"){e.strokeStyle=s,e.lineWidth=2,e.beginPath(),e.moveTo(this.v1.x,this.v1.y),e.lineTo(this.v2.x,this.v2.y),e.stroke()}}class b extends q{constructor(e,s,i){super(e,s);r(this,"refractiveIndex");r(this,"criticalAngle");this.refractiveIndex=i,this.criticalAngle=Math.asin(1/this.refractiveIndex)}handle(e,s){return E(s,this.normal,this.refractiveIndex,this.criticalAngle)}}var l=(a=>(a.Number="number",a.String="text",a.Boolean="checkbox",a.Color="color",a.Vector="vector",a))(l||{});class A{constructor(t,e){r(this,"pos");r(this,"rot");r(this,"bounds");r(this,"name");r(this,"color","#ffffff");r(this,"displayBounds",!1);r(this,"attributes");r(this,"surfaces",[]);r(this,"lightRays",[]);this.pos=t,this.rot=0,this.name=e,this.bounds=new x(n.zero(),n.zero()),this.attributes=[{name:"color",type:l.Color},{name:"displayBounds",type:l.Boolean},{name:"pos",type:l.Vector},{name:"rot",type:l.Number}]}setPosition(t){const e=n.sub(t,this.pos);this.pos=t,this.updateTransforms(e,0),this.updateBounds()}setRotation(t){const e=t-this.rot;this.rot=t,this.updateTransforms(n.zero(),e),this.updateBounds()}translate(t){this.pos.add(t),this.updateTransforms(t,0),this.updateBounds()}rotate(t){this.rot+=t,this.updateTransforms(n.zero(),t),this.updateBounds()}updateTransforms(t,e){}updateBounds(){}updateAttribute(t,e){switch(console.log("updating attribute",t,e),t){case"pos":this.setPosition(e);break;case"rot":this.setRotation(e);break;case"color":this.color=e;break;case"displayBounds":this.displayBounds=e;break}}render(t,e){this.displayBounds&&this.bounds.render(t),e&&this.bounds.render(t,"#8424b9",2)}}class w extends A{constructor(t,e){super(t,e)}updateTransforms(t,e){for(let s of this.surfaces)s.translate(t),s.rotateAboutAxis(e,this.pos.copy())}updateBounds(){let t=[];for(let e of this.surfaces){const s=e.calculateAABB();t.push(s)}this.bounds=x.fromAABBs(t)}render(t,e){for(let s of this.surfaces)s.render(t,this.color);super.render(t,e)}}class z extends w{constructor(e){super(e,"Concave Lens");r(this,"span");r(this,"radiusOfCurvature");r(this,"thickness");r(this,"refractiveIndex");this.span=.4,this.radiusOfCurvature=500,this.thickness=4,this.refractiveIndex=1.666,this.init(),this.attributes.push({name:"span",type:l.Number,min:0,max:1e3}),this.attributes.push({name:"radiusOfCurvature",type:l.Number,min:0,max:1e3}),this.attributes.push({name:"thickness",type:l.Number,min:0,max:1e3}),this.attributes.push({name:"refractiveIndex",type:l.Number,min:.1,max:10})}init(){let e=this.radiusOfCurvature+this.thickness/2,s=this.radiusOfCurvature*Math.sin(this.span/2),i=this.radiusOfCurvature-Math.cos(this.span/2)*this.radiusOfCurvature+this.thickness/2;this.surfaces=[new v(new n(this.pos.x-e,this.pos.y),this.radiusOfCurvature,n.right(),this.span,this.refractiveIndex,-1),new v(new n(this.pos.x+e,this.pos.y),this.radiusOfCurvature,n.left(),this.span,this.refractiveIndex,-1),new b(new n(this.pos.x-i,this.pos.y+s),new n(this.pos.x+i,this.pos.y+s),this.refractiveIndex),new b(new n(this.pos.x+i,this.pos.y-s),new n(this.pos.x-i,this.pos.y-s),this.refractiveIndex)],this.updateBounds()}updateAttribute(e,s){switch(e){case"span":this.span=s,this.init();break;case"radiusOfCurvature":this.radiusOfCurvature=s,this.init();break;case"thickness":this.thickness=s,this.init();break;case"refractiveIndex":this.refractiveIndex=s,this.surfaces.forEach(i=>{i.refractiveIndex=this.refractiveIndex});break}}}class T extends w{constructor(e){super(e,"Convex Lens");r(this,"span");r(this,"radiusOfCurvature");r(this,"refractiveIndex");this.span=1,this.radiusOfCurvature=200,this.refractiveIndex=1.666,this.init(),this.attributes.push({name:"span",type:l.Number,min:0,max:1e3}),this.attributes.push({name:"radiusOfCurvature",type:l.Number,min:0,max:1e3}),this.attributes.push({name:"refractiveIndex",type:l.Number,min:.1,max:10})}init(){let e=this.radiusOfCurvature*Math.sin(this.span/2),s=Math.sqrt(this.radiusOfCurvature**2-e**2);this.surfaces=[new v(new n(this.pos.x-s,this.pos.y),this.radiusOfCurvature,n.right(),this.span,this.refractiveIndex),new v(new n(this.pos.x+s,this.pos.y),this.radiusOfCurvature,n.left(),this.span,this.refractiveIndex)],this.updateBounds()}updateAttribute(e,s){switch(e){case"span":this.span=s,this.init();break;case"radiusOfCurvature":this.radiusOfCurvature=s,this.init();break;case"refractiveIndex":this.refractiveIndex=s,this.surfaces.forEach(i=>{i.refractiveIndex=this.refractiveIndex});break}}}class D extends w{constructor(e){super(e,"Glass Sphere");r(this,"radius");r(this,"refractiveIndex");this.radius=100,this.refractiveIndex=1.666,this.init(),this.attributes.push({name:"radius",type:l.Number,min:0,max:1e3})}init(){this.surfaces=[new v(this.pos.copy(),this.radius,n.right(),Math.PI*2,this.refractiveIndex)],this.updateBounds()}updateAttribute(e,s){switch(e){case"radius":this.radius=s,this.init();break}}}class F{constructor(t,e){r(this,"origin");r(this,"dir");r(this,"path");this.origin=t,this.dir=e.copy(),this.path=[this.origin]}trace(t){this.path=[this.origin];let e=this.path[0],s=this.dir.copy(),i=null;for(let h=0;h<50;h++){let o=null,u=null,d=1/0;for(let f=0;f<t.length;f++){if(f===i&&!t[f].canIntersectTwice)continue;let p=t[f].intersects(e.copy(),s.copy());if(!p)continue;let g=n.sub(p,e).magSq();g<d&&(o=p,d=g,u=f)}if(o&&u!==null)this.path.push(o),e=o,s=t[u].handle(o.copy(),s.copy()).copy(),i=u;else break}this.path.push(e.copy().add(s.mult(3e3)))}render(t){t.moveTo(this.origin.x,this.origin.y);for(let e of this.path)t.lineTo(e.x,e.y)}}class W extends A{constructor(e){super(e,"Point Light");r(this,"numRays");this.numRays=1e3,this.init(),this.attributes.push({name:"numRays",type:l.Number,min:0,max:1e4})}init(){this.lightRays=[];for(let e=0;e<this.numRays;e++)this.lightRays.push(new F(this.pos,new n(1,0).rotate(Math.PI*2/this.numRays*e)));this.updateBounds()}updateTransforms(e,s){for(let i of this.lightRays)i.origin=this.pos}updateBounds(){this.bounds=x.fromPoints([this.pos.copy(),this.pos.copy()]),this.bounds.setMinSize(50)}updateAttribute(e,s){switch(super.updateAttribute(e,s),e){case"numRays":this.numRays=s,this.init();break}}}const I=[new n(0,-Math.sqrt(3)/3),new n(.5,Math.sqrt(3)/6),new n(-.5,Math.sqrt(3)/6)];class V extends w{constructor(e){super(e,"Prism");r(this,"size");r(this,"refractiveIndex");this.size=200,this.refractiveIndex=1.5,this.init(),this.attributes.push({name:"size",type:l.Number,min:0,max:1e3}),this.attributes.push({name:"refractiveIndex",type:l.Number,min:.1,max:10})}init(){let e=n.add(this.pos,I[0].copy().mult(this.size).rotate(this.rot)),s=n.add(this.pos,I[1].copy().mult(this.size).rotate(this.rot)),i=n.add(this.pos,I[2].copy().mult(this.size).rotate(this.rot));this.surfaces=[new b(s.copy(),e.copy(),this.refractiveIndex),new b(i.copy(),s.copy(),this.refractiveIndex),new b(e.copy(),i.copy(),this.refractiveIndex)],this.updateBounds()}updateAttribute(e,s){switch(super.updateAttribute(e,s),e){case"size":this.size=s,this.init();break;case"refractiveIndex":this.refractiveIndex=s;for(const i of this.surfaces)i.refractiveIndex=this.refractiveIndex;break}}}class Y{constructor(){r(this,"baseElement");r(this,"selectedEntity",null);this.baseElement=document.getElementById("sidebar")}selectEntity(t){this.selectedEntity=t,this.baseElement.innerHTML=t.name+"<br/>",this.createEntityAttributesDOM(t)}createEntityAttributesDOM(t){console.log(t.attributes);for(const e of t.attributes){const s=this.createAttributeDOM(t,e);this.baseElement.appendChild(s)}}createAttributeDOM(t,e){console.log(this.selectEntity);const s=document.createElement("div"),i=document.createElement("label");switch(i.innerText=e.name,s.appendChild(i),e.type){case l.Vector:const h=t[e.name];console.log(e.name);let o;o=document.createElement("input"),o.type="number",o.value=h.x.toString();let u;u=document.createElement("input"),u.type="number",u.value=h.y.toString(),s.appendChild(o),s.appendChild(u),o.addEventListener("input",p=>{const g=new n(parseFloat(p.target.value),parseFloat(u.value));t.updateAttribute(e.name,g)}),u.addEventListener("input",p=>{const g=new n(parseFloat(p.target.value),parseFloat(u.value));t.updateAttribute(e.name,g)});break;case l.Boolean:const d=document.createElement("input");d.type="checkbox",d.checked=t[e.name],s.appendChild(d),d.addEventListener("input",p=>{t.updateAttribute(e.name,p.target.checked)});break;default:const f=document.createElement("input");f.type=e.type,f.value=t[e.name].toString(),s.appendChild(f),f.addEventListener("input",p=>{t.updateAttribute(e.name,p.target.value)});break}return s}}class U{constructor(){r(this,"surfaces",[]);r(this,"lightRays",[]);r(this,"entities",[]);r(this,"worldOffset",n.zero());r(this,"worldScale",1);r(this,"selectedEntityIndex",-1);r(this,"isMouseDown",!1);r(this,"lastMousePos",n.zero());r(this,"isSelectedEntityBeingDragged",!1);r(this,"ui",new Y)}addEntity(t){this.entities.push(t)}update(){this.surfaces=this.entities.map(t=>t.surfaces).flat(),this.lightRays=this.entities.map(t=>t.lightRays).flat();for(let t of this.lightRays)t.trace(this.surfaces)}handleMouseDown(t){const e=n.sub(t,this.worldOffset).div(this.worldScale);this.selectedEntityIndex=-1;for(let s=0;s<this.entities.length;s++)if(this.entities[s].bounds.has(e)){console.log("Selected entity:",this.entities[s]),this.selectedEntityIndex=s,this.isSelectedEntityBeingDragged=!0,this.ui.selectEntity(this.entities[s]);break}this.isMouseDown=!0}handleMouseMove(t){const e=n.sub(t,this.lastMousePos),s=e.copy().div(this.worldScale);if(this.lastMousePos=t,this.isMouseDown){if(this.isSelectedEntityBeingDragged){this.entities[this.selectedEntityIndex].translate(s);return}if(this.selectedEntityIndex===-1){this.worldOffset.add(e);return}}const i=n.sub(t,this.worldOffset).div(this.worldScale);for(let h of this.entities){if(h.bounds.has(i)){h.displayBounds=!0;continue}h.displayBounds=!1}}handleMouseUp(t){this.isMouseDown=!1,this.isSelectedEntityBeingDragged=!1}handleMouseWheel(t){this.worldScale+=t/1e3,this.worldScale=Math.max(Math.min(this.worldScale,1),.1)}render(t){t.save(),t.translate(this.worldOffset.x,this.worldOffset.y),t.scale(this.worldScale,this.worldScale),t.beginPath();for(let e of this.lightRays)e.render(t);t.strokeStyle="rgba(255, 255, 255, 0.2)",t.lineWidth=1,t.stroke();for(let e=0;e<this.entities.length;e++)this.entities[e].render(t,this.selectedEntityIndex==e);t.restore()}}const m=document.getElementById("display"),M=m.getContext("2d");m.width=window.innerWidth;m.height=window.innerHeight;const y=new U,X=new V(new n(200,150));y.addEntity(X);const G=new W(new n(700,400));y.addEntity(G);let H=new T(new n(800,300));y.addEntity(H);let K=new z(new n(500,300));y.addEntity(K);let Q=new D(new n(200,500));y.addEntity(Q);m.addEventListener("mousedown",a=>{y.handleMouseDown(new n(a.clientX,a.clientY))});m.addEventListener("mousemove",a=>{y.handleMouseMove(new n(a.clientX,a.clientY))});m.addEventListener("mouseup",a=>{y.handleMouseUp(new n(a.clientX,a.clientY))});m.addEventListener("wheel",a=>{y.handleMouseWheel(-a.deltaY)});function B(){requestAnimationFrame(B),M.fillStyle="black",M.fillRect(0,0,m.width,m.height),y.update(),y.render(M)}B();
