var q=Object.defineProperty;var T=(a,t,e)=>t in a?q(a,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):a[t]=e;var l=(a,t,e)=>(T(a,typeof t!="symbol"?t+"":t,e),e);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const r of i)if(r.type==="childList")for(const h of r.addedNodes)h.tagName==="LINK"&&h.rel==="modulepreload"&&s(h)}).observe(document,{childList:!0,subtree:!0});function e(i){const r={};return i.integrity&&(r.integrity=i.integrity),i.referrerPolicy&&(r.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?r.credentials="include":i.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function s(i){if(i.ep)return;i.ep=!0;const r=e(i);fetch(i.href,r)}})();class M{constructor(t){l(this,"pos");this.pos=t}}class n{constructor(t,e){l(this,"x");l(this,"y");this.x=t,this.y=e}add(t,e){return t instanceof n?(this.x+=t.x,this.y+=t.y):e?(this.x+=t,this.y+=e):(this.x+=t,this.y+=t),this}static add(t,e){return new n(t.x+e.x,t.y+e.y)}mult(t,e){return t instanceof n?(this.x*=t.x,this.y*=t.y):e?(this.x*=t,this.y*=e):(this.x*=t,this.y*=t),this}static mult(t,e){return new n(t.x*e.x,t.y*e.y)}sub(t,e){return t instanceof n?(this.x-=t.x,this.y-=t.y):e?(this.x-=t,this.y-=e):(this.x-=t,this.y-=t),this}static sub(t,e){return new n(t.x-e.x,t.y-e.y)}div(t,e){return t instanceof n?(this.x/=t.x,this.y/=t.y):e?(this.x/=t,this.y/=e):(this.x/=t,this.y/=t),this}static div(t,e){return new n(t.x/e.x,t.y/e.y)}set(t,e){return t instanceof n?(this.x=t.x,this.y=t.y):e?(this.x=t,this.y=e):(this.x=t,this.y=t),this}mag(){return Math.sqrt(this.x*this.x+this.y*this.y)}static mag(t){return Math.sqrt(t.x*t.x+t.y*t.y)}magSq(){return this.x*this.x+this.y*this.y}static magSq(t){return t.x*t.x+t.y*t.y}setMag(t){let e=this.mag();return this.x*=t/e,this.y*=t/e,this}normalize(){return this.setMag(1),this}limit(t){return this.mag()>t&&this.setMag(t),this}heading(){return Math.atan2(this.y,this.x)}rotate(t){let e=Math.cos(t),s=Math.sin(t),i=e*this.x-s*this.y,r=e*this.y+s*this.x;return this.x=i,this.y=r,this}dot(t){return t.x*this.x+t.y*this.y}static dot(t,e){return t.x*e.x+t.y*e.y}cross(t){return this.x*t.y-this.y*t.x}static cross(t,e){return t.x*e.y-t.y*e.x}dist(t){return Math.sqrt(Math.pow(this.x-t.x,2)+Math.pow(this.y-t.y,2))}static dist(t,e){return Math.sqrt(Math.pow(e.x-t.x,2)+Math.pow(e.y-t.y,2))}lerp(t,e){let s=t.x-this.x,i=t.y-this.y;return this.x+=e*s,this.y+=e*i,this}static angleBetween(t,e){return Math.atan2(t.x*e.y-t.y*e.x,t.x*e.x+t.y*e.y)}copy(){return new n(this.x,this.y)}}class O{constructor(t,e){l(this,"origin");l(this,"dir");l(this,"path");this.origin=t,this.dir=e.copy(),this.path=[this.origin]}trace(t){this.path=[this.origin];let e=this.path[0],s=this.dir.copy(),i=null;for(let r=0;r<500;r++){let h=null,o=null,c=1/0;for(let u=0;u<t.length;u++){if(u===i&&!t[u].canIntersectTwice)continue;let d=t[u].intersects(e.copy(),s.copy());if(!d)continue;let x=n.sub(d,e).magSq();x<c&&(h=d,c=x,o=u)}if(h&&o!==null)this.path.push(h),e=h,s=t[o].handle(h.copy(),s.copy()).copy(),i=o;else break}this.path.push(e.copy().add(s.mult(2e3)))}render(t){t.moveTo(this.origin.x,this.origin.y);for(let e of this.path)t.lineTo(e.x,e.y)}}class A extends M{constructor(e){super(e);l(this,"numRays");l(this,"lightRays");this.numRays=1e3,this.lightRays=[];for(let s=0;s<this.numRays;s++)this.lightRays.push(new O(this.pos,new n(1,0).rotate(Math.PI*2/this.numRays*s)))}addToWorld(e){for(let s of this.lightRays)e.addLightRay(s)}handleClick(e){return!1}render(e){}}function z(a,t,e,s){let i=n.sub(t,a),r=n.sub(a,e),h=n.cross(s,i),o=n.cross(r,i)/h,c=n.cross(r,s)/h;return o>=0&&c>=0&&c<=1?n.add(e,s.mult(o)):null}function E(a,t,e,s=.1){let i=n.sub(a,e).mag(),r=n.sub(t,e).mag(),h=n.sub(t,a).mag();return Math.abs(i+r-h)<s}function k(a,t,e){let s=n.sub(e,a),i=n.dot(s,t)/t.magSq();return n.add(a,t.mult(Math.max(i,0)))}class P{}class L extends P{constructor(e,s){super();l(this,"v1");l(this,"v2");l(this,"normal",new n(0,0));l(this,"canIntersectTwice",!1);this.v1=e,this.v2=s,this.calculateNormal()}calculateNormal(){this.normal=n.sub(this.v2,this.v1).rotate(Math.PI/2).normalize()}setVertices(e,s){this.v1=e.copy(),this.v2=s.copy(),this.calculateNormal()}intersects(e,s){return z(this.v1.copy(),this.v2.copy(),e.copy(),s.copy())}intersectsPoint(e,s=.1){return E(this.v1.copy(),this.v2.copy(),e.copy(),s)}render(e){e.strokeStyle="white",e.lineWidth=2,e.beginPath(),e.moveTo(this.v1.x,this.v1.y),e.lineTo(this.v2.x,this.v2.y),e.stroke();const s=n.add(this.v1,this.v2).mult(.5);e.strokeStyle="red",e.lineWidth=1,e.beginPath(),e.moveTo(s.x,s.y),e.lineTo(s.x+this.normal.x*50,s.y+this.normal.y*50),e.stroke()}}function I(a,t){return n.sub(a,t.copy().mult(2*n.dot(a,t)/t.magSq()))}class m extends L{constructor(e,s,i){super(e,s);l(this,"refractiveIndex");l(this,"criticalAngle");this.refractiveIndex=i,this.criticalAngle=Math.asin(1/this.refractiveIndex)}handle(e,s){let i=Math.atan2(s.y,s.x)-Math.atan2(this.normal.y,this.normal.x);if(i>Math.PI/2||i<-Math.PI/2){let r=Math.PI-i,h=Math.asin(Math.sin(r)/this.refractiveIndex),o=r-h;return s.copy().rotate(o)}else{let r=i;if(r>this.criticalAngle||r<-this.criticalAngle)return I(s,this.normal);let h=Math.asin(Math.sin(r)*this.refractiveIndex),o=r-h;return s.copy().rotate(-o)}}}class C{constructor(t){l(this,"pos");l(this,"radius");l(this,"state");this.pos=t,this.radius=6,this.state=0}update(t,e){e||(this.state=0),this.state===2?(this.pos=t.copy(),e||(this.state=0)):this.state===1?e&&(this.state=2):t.dist(this.pos)<this.radius?this.state=1:this.state=0}render(t){let e=this.state===1?this.radius*1.5:this.radius;t.beginPath(),t.arc(this.pos.x,this.pos.y,e,0,2*Math.PI),t.fillStyle="yellow",t.fill()}}const y=[new n(0,-Math.sqrt(3)/3),new n(.5,Math.sqrt(3)/6),new n(-.5,Math.sqrt(3)/6)];class B extends M{constructor(e){super(e);l(this,"angle");l(this,"size");l(this,"refractiveIndex");l(this,"surfaces");l(this,"posDrag");this.size=200,this.refractiveIndex=1.5,this.angle=0,this.posDrag=new C(e);let s=n.add(this.pos,y[0].copy().mult(this.size).rotate(this.angle)),i=n.add(this.pos,y[1].copy().mult(this.size).rotate(this.angle)),r=n.add(this.pos,y[2].copy().mult(this.size).rotate(this.angle));this.surfaces=[new m(i,s,this.refractiveIndex),new m(r,i,this.refractiveIndex),new m(s,r,this.refractiveIndex)],this.recalculateVertices()}addToWorld(e){for(let s of this.surfaces)e.addSurface(s)}rotate(e){this.angle+=e,this.recalculateVertices()}recalculateVertices(){let e=n.add(this.pos,y[0].copy().mult(this.size).rotate(this.angle)),s=n.add(this.pos,y[1].copy().mult(this.size).rotate(this.angle)),i=n.add(this.pos,y[2].copy().mult(this.size).rotate(this.angle));this.surfaces[0].setVertices(s,e),this.surfaces[1].setVertices(i,s),this.surfaces[2].setVertices(e,i)}handleClick(e){for(let s of this.surfaces)if(s.intersectsPoint(e,10))return console.log("YEE"),!0;return!1}render(e){for(let s of this.surfaces)s.render(e)}}class S extends P{constructor(e,s,i,r){super();l(this,"center");l(this,"radius");l(this,"facing");l(this,"span");l(this,"canIntersectTwice",!0);this.center=e,this.radius=s,this.facing=i,this.span=r}intersects(e,s){let i=k(e.copy(),s.copy(),this.center),r=n.sub(i,this.center).magSq();if(r>this.radius*this.radius)return null;let h=Math.sqrt(this.radius*this.radius-r);if(n.sub(e,i).magSq()>h*h){let d=n.sub(i,s.copy().normalize().mult(h)),x=n.sub(d,this.center);if(Math.abs(n.angleBetween(x,this.facing))<=this.span/2&&e.dist(d)>.01)return d}let o=n.add(i,s.copy().normalize().mult(h)),c=n.sub(o,this.center);return Math.abs(n.angleBetween(c,this.facing))<=this.span/2&&e.dist(o)>.01?o:null}render(e){let s=this.facing.heading()-this.span/2,i=this.facing.heading()+this.span/2;e.beginPath(),e.strokeStyle="white",e.lineWidth=2,e.arc(this.center.x,this.center.y,this.radius,s,i),e.stroke()}}class W extends S{constructor(t,e,s,i){super(t,e,s,i)}handle(t,e){let s=n.sub(t,this.center).normalize();return I(e,s)}}class F extends S{constructor(e,s,i,r,h){super(e,s,i,r);l(this,"refractiveIndex");l(this,"criticalAngle");this.refractiveIndex=h,this.criticalAngle=Math.asin(1/this.refractiveIndex)}handle(e,s){let i=n.sub(e,this.center).normalize(),r=Math.atan2(s.y,s.x)-Math.atan2(i.y,i.x);if(r>Math.PI/2||r<-Math.PI/2){let h=Math.PI-r,o=Math.asin(Math.sin(h)/this.refractiveIndex),c=h-o;return s.copy().rotate(c)}else{let h=r;if(h>this.criticalAngle||h<-this.criticalAngle)return I(s,i);let o=Math.asin(Math.sin(h)*this.refractiveIndex),c=h-o;return s.copy().rotate(-c)}}}class N{constructor(){l(this,"surfaces",[]);l(this,"lightRays",[]);l(this,"entities",[])}addSurface(t){this.surfaces.push(t)}addLightRay(t){this.lightRays.push(t)}addEntity(t){this.entities.push(t),t.addToWorld(this)}update(){for(let t of this.lightRays)t.trace(this.surfaces)}handleClick(t){for(let e of this.entities)e.handleClick(t)}render(t){t.beginPath();for(let e of this.lightRays)e.render(t);t.strokeStyle="rgba(255, 255, 255, 0.2)",t.lineWidth=1,t.stroke();for(let e of this.entities)e.render(t)}}const p=document.getElementById("display"),g=p.getContext("2d");p.width=window.innerWidth;p.height=window.innerHeight;const f=new N,R=new B(new n(200,150));f.addEntity(R);f.addEntity(new A(new n(300,300)));const w=new W(new n(700,300),100,new n(-1,0),3),v=new F(new n(400,500),100,new n(-1,0),3,2);f.addSurface(w);f.addSurface(v);window.addEventListener("click",a=>{f.handleClick(new n(a.clientX,a.clientY))});function b(){requestAnimationFrame(b),g.fillStyle="black",g.fillRect(0,0,p.width,p.height),R.rotate(-.001),w.facing.rotate(.005),v.facing.rotate(-.01),f.update(),w.render(g),v.render(g),f.render(g)}b();
