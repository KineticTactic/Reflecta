var B=Object.defineProperty;var E=(a,e,t)=>e in a?B(a,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):a[e]=t;var r=(a,e,t)=>(E(a,typeof e!="symbol"?e+"":e,t),t);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const h of i)if(h.type==="childList")for(const o of h.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&s(o)}).observe(document,{childList:!0,subtree:!0});function t(i){const h={};return i.integrity&&(h.integrity=i.integrity),i.referrerPolicy&&(h.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?h.credentials="include":i.crossOrigin==="anonymous"?h.credentials="omit":h.credentials="same-origin",h}function s(i){if(i.ep)return;i.ep=!0;const h=t(i);fetch(i.href,h)}})();const l=class{constructor(e,t){r(this,"x");r(this,"y");this.x=e,this.y=t}add(e,t){return e instanceof l?(this.x+=e.x,this.y+=e.y):t?(this.x+=e,this.y+=t):(this.x+=e,this.y+=e),this}static add(e,t){return new l(e.x+t.x,e.y+t.y)}mult(e,t){return e instanceof l?(this.x*=e.x,this.y*=e.y):t?(this.x*=e,this.y*=t):(this.x*=e,this.y*=e),this}static mult(e,t){return t instanceof l?new l(e.x*t.x,e.y*t.y):new l(e.x*t,e.y*t)}sub(e,t){return e instanceof l?(this.x-=e.x,this.y-=e.y):t?(this.x-=e,this.y-=t):(this.x-=e,this.y-=e),this}static sub(e,t){return new l(e.x-t.x,e.y-t.y)}div(e,t){return e instanceof l?(this.x/=e.x,this.y/=e.y):t?(this.x/=e,this.y/=t):(this.x/=e,this.y/=e),this}static div(e,t){return new l(e.x/t.x,e.y/t.y)}set(e,t){return e instanceof l?(this.x=e.x,this.y=e.y):t?(this.x=e,this.y=t):(this.x=e,this.y=e),this}mag(){return Math.sqrt(this.x*this.x+this.y*this.y)}static mag(e){return Math.sqrt(e.x*e.x+e.y*e.y)}magSq(){return this.x*this.x+this.y*this.y}static magSq(e){return e.x*e.x+e.y*e.y}setMag(e){let t=this.mag();return this.x*=e/t,this.y*=e/t,this}normalize(){return this.setMag(1),this}limit(e){return this.mag()>e&&this.setMag(e),this}heading(){return Math.atan2(this.y,this.x)}rotate(e){let t=Math.cos(e),s=Math.sin(e),i=t*this.x-s*this.y,h=t*this.y+s*this.x;return this.x=i,this.y=h,this}rotateAboutAxis(e,t){return this.sub(t).rotate(e).add(t),this}dot(e){return e.x*this.x+e.y*this.y}static dot(e,t){return e.x*t.x+e.y*t.y}cross(e){return this.x*e.y-this.y*e.x}static cross(e,t){return e.x*t.y-e.y*t.x}dist(e){return Math.sqrt(Math.pow(this.x-e.x,2)+Math.pow(this.y-e.y,2))}static dist(e,t){return Math.sqrt(Math.pow(t.x-e.x,2)+Math.pow(t.y-e.y,2))}lerp(e,t){let s=e.x-this.x,i=e.y-this.y;return this.x+=t*s,this.y+=t*i,this}static angleBetween(e,t){return Math.atan2(e.x*t.y-e.y*t.x,e.x*t.x+e.y*t.y)}copy(){return new l(this.x,this.y)}};let n=l;r(n,"ZERO",new l(0,0)),r(n,"UP",new l(0,-1)),r(n,"DOWN",new l(0,1)),r(n,"LEFT",new l(-1,0)),r(n,"RIGHT",new l(1,0));function R(a,e){return n.sub(a,e.copy().mult(2*n.dot(a,e)/e.magSq()))}function b(a,e,t,s){let i=Math.atan2(a.y,a.x)-Math.atan2(e.y,e.x);if(i>Math.PI&&(i=-(Math.PI*2-i)),i<-Math.PI&&(i=Math.PI*2+i),i>Math.PI/2||i<-Math.PI/2){let h=Math.PI-i,o=Math.asin(Math.sin(h)/t),c=h-o;return a.copy().rotate(c)}else{let h=i;if(h>s||h<-s)return R(a,e);let o=Math.asin(Math.sin(h)*t),c=h-o;return a.copy().rotate(-c)}}function A(a,e,t,s){let i=n.sub(e,a),h=n.sub(a,t),o=n.cross(s,i),c=n.cross(h,i)/o,u=n.cross(h,s)/o;return c>=0&&u>=0&&u<=1?n.add(t,s.mult(c)):null}function T(a,e,t,s=.1){let i=n.sub(a,t).mag(),h=n.sub(e,t).mag(),o=n.sub(e,a).mag();return Math.abs(i+h-o)<s}function C(a,e,t){let s=n.sub(t,a),i=n.dot(s,e)/e.magSq();return n.add(a,e.mult(i))}class y{constructor(e,t){r(this,"start");r(this,"end");this.start=e,this.end=t}has(e){return!(e.x<this.start.x||e.x>this.end.x||e.y<this.start.y||e.y>this.end.y)}setMinSize(e){if(Math.abs(this.start.x-this.end.x)<e){let t=e-Math.abs(this.start.x-this.end.x);this.start.x-=t/2,this.end.x+=t/2}if(Math.abs(this.start.y-this.end.y)<e){let t=e-Math.abs(this.start.y-this.end.y);this.start.y-=t/2,this.end.y+=t/2}}render(e,t="#8424b9",s=1){e.strokeStyle=t,e.lineWidth=s,e.strokeRect(this.start.x,this.start.y,this.end.x-this.start.x,this.end.y-this.start.y)}static fromPoints(e){let t=e[0].copy(),s=e[0].copy();for(let i of e)i.x<t.x?t.x=i.x:i.x>s.x&&(s.x=i.x),i.y<t.y?t.y=i.y:i.y>s.y&&(s.y=i.y);return new y(t,s)}static fromAABBs(e){const t=[];for(let s of e)t.push(s.start,s.end);return y.fromPoints(t)}}class P{}class q extends P{constructor(t,s,i,h){super();r(this,"center");r(this,"radius");r(this,"facing");r(this,"span");r(this,"canIntersectTwice",!0);this.center=t,this.radius=s,this.facing=i,this.span=h}intersects(t,s){let i=C(t.copy(),s.copy(),this.center),h=n.sub(i,this.center).magSq();if(h>this.radius*this.radius)return null;let o=Math.sqrt(this.radius*this.radius-h);if(n.sub(t,i).magSq()>o*o){let u=n.sub(i,s.copy().normalize().mult(o));if(!(Math.abs(n.angleBetween(n.sub(u,t),s))>.2)){let d=n.sub(u,this.center);if(Math.abs(n.angleBetween(d,this.facing))<=this.span/2&&t.dist(u)>.01)return u}}let c=n.add(i,s.copy().normalize().mult(o));if(!(Math.abs(n.angleBetween(n.sub(c,t),s))>.2)){let u=n.sub(c,this.center);if(Math.abs(n.angleBetween(u,this.facing))<=this.span/2&&t.dist(c)>.01)return c}return null}translate(t){this.center.add(t)}rotateAboutAxis(t,s){this.center.rotateAboutAxis(t,s),this.facing.rotate(t)}calculateAABB(){const t=[n.UP,n.DOWN,n.LEFT,n.RIGHT],s=[];for(const i of t)Math.abs(n.angleBetween(i,this.facing))<this.span/2&&s.push(n.add(this.center,n.mult(i,this.radius)));return s.push(n.add(this.center,n.mult(this.facing.copy().rotate(this.span/2),this.radius))),s.push(n.add(this.center,n.mult(this.facing.copy().rotate(-this.span/2),this.radius))),y.fromPoints(s)}render(t){let s=this.facing.heading()-this.span/2,i=this.facing.heading()+this.span/2;t.beginPath(),t.strokeStyle="white",t.lineWidth=2,t.arc(this.center.x,this.center.y,this.radius,s,i),t.stroke()}}class x extends q{constructor(t,s,i,h,o,c=1){super(t,s,i,h);r(this,"refractiveIndex");r(this,"criticalAngle");r(this,"normal");this.refractiveIndex=o,this.criticalAngle=Math.asin(1/this.refractiveIndex),this.normal=c}handle(t,s){let i=n.sub(t,this.center).normalize().mult(this.normal);return b(s,i,this.refractiveIndex,this.criticalAngle)}}class L extends P{constructor(t,s){super();r(this,"v1");r(this,"v2");r(this,"normal",new n(0,0));r(this,"canIntersectTwice",!1);this.v1=t,this.v2=s,this.calculateNormal()}calculateNormal(){this.normal=n.sub(this.v2,this.v1).rotate(Math.PI/2).normalize()}setVertices(t,s){this.v1=t.copy(),this.v2=s.copy(),this.calculateNormal()}translate(t){this.v1.add(t),this.v2.add(t),this.calculateNormal()}rotateAboutAxis(t,s){this.v1.rotateAboutAxis(t,s),this.v2.rotateAboutAxis(t,s),this.calculateNormal()}intersects(t,s){return A(this.v1.copy(),this.v2.copy(),t.copy(),s.copy())}intersectsPoint(t,s=.1){return T(this.v1.copy(),this.v2.copy(),t.copy(),s)}calculateAABB(){return y.fromPoints([this.v1,this.v2])}render(t){t.strokeStyle="white",t.lineWidth=2,t.beginPath(),t.moveTo(this.v1.x,this.v1.y),t.lineTo(this.v2.x,this.v2.y),t.stroke()}}class p extends L{constructor(t,s,i){super(t,s);r(this,"refractiveIndex");r(this,"criticalAngle");this.refractiveIndex=i,this.criticalAngle=Math.asin(1/this.refractiveIndex)}handle(t,s){return b(s,this.normal,this.refractiveIndex,this.criticalAngle)}}class S{constructor(e){r(this,"pos");r(this,"rot");r(this,"bounds");r(this,"displayBounds",!1);this.pos=e,this.rot=0,this.bounds=new y(n.ZERO,n.ZERO)}setPosition(e){const t=n.sub(e,this.pos);this.updateTransforms(t,0),this.updateBounds()}translate(e){this.pos.add(e),this.updateTransforms(e,0),this.updateBounds()}rotate(e){this.rot+=e,this.updateTransforms(n.ZERO,e),this.updateBounds()}updateTransforms(e,t){}updateBounds(){}render(e,t){this.displayBounds&&this.bounds.render(e),t&&this.bounds.render(e,"#8424b9",2)}}class m extends S{constructor(t){super(t);r(this,"surfaces");this.surfaces=[]}updateTransforms(t,s){for(let i of this.surfaces)i.translate(t),i.rotateAboutAxis(s,this.pos.copy())}updateBounds(){let t=[];for(let s of this.surfaces){const i=s.calculateAABB();t.push(i)}this.bounds=y.fromAABBs(t)}addToWorld(t){for(let s of this.surfaces)t.addSurface(s)}render(t,s){for(let i of this.surfaces)i.render(t);super.render(t,s)}}class D extends m{constructor(t){super(t);r(this,"span");r(this,"radiusOfCurvature");r(this,"thickness");r(this,"refractiveIndex");this.span=.4,this.radiusOfCurvature=500,this.thickness=4,this.refractiveIndex=1.666;let s=this.radiusOfCurvature+this.thickness/2,i=this.radiusOfCurvature*Math.sin(this.span/2),h=this.radiusOfCurvature-Math.cos(this.span/2)*this.radiusOfCurvature+this.thickness/2;this.surfaces=[new x(new n(t.x-s,t.y),this.radiusOfCurvature,new n(1,0),this.span,this.refractiveIndex,-1),new x(new n(t.x+s,t.y),this.radiusOfCurvature,new n(-1,0),this.span,this.refractiveIndex,-1),new p(new n(t.x-h,t.y+i),new n(t.x+h,t.y+i),this.refractiveIndex),new p(new n(t.x+h,t.y-i),new n(t.x-h,t.y-i),this.refractiveIndex)],this.updateBounds()}}class W extends m{constructor(t){super(t);r(this,"angle");r(this,"span");r(this,"radiusOfCurvature");r(this,"refractiveIndex");this.span=1,this.radiusOfCurvature=200,this.refractiveIndex=1.666,this.angle=0;let s=this.radiusOfCurvature*Math.sin(this.span/2),i=Math.sqrt(this.radiusOfCurvature**2-s**2);this.surfaces=[new x(new n(t.x-i,t.y),this.radiusOfCurvature,new n(1,0),this.span,this.refractiveIndex),new x(new n(t.x+i,t.y),this.radiusOfCurvature,new n(-1,0),this.span,this.refractiveIndex)],this.updateBounds()}}class k extends m{constructor(t){super(t);r(this,"radius");r(this,"refractiveIndex");this.radius=100,this.refractiveIndex=1.666,this.surfaces=[new x(t.copy(),this.radius,new n(1,0),Math.PI*2,this.refractiveIndex)],this.updateBounds()}}class N{constructor(e,t){r(this,"origin");r(this,"dir");r(this,"path");this.origin=e,this.dir=t.copy(),this.path=[this.origin]}trace(e){this.path=[this.origin];let t=this.path[0],s=this.dir.copy(),i=null;for(let h=0;h<50;h++){let o=null,c=null,u=1/0;for(let d=0;d<e.length;d++){if(d===i&&!e[d].canIntersectTwice)continue;let g=e[d].intersects(t.copy(),s.copy());if(!g)continue;let I=n.sub(g,t).magSq();I<u&&(o=g,u=I,c=d)}if(o&&c!==null)this.path.push(o),t=o,s=e[c].handle(o.copy(),s.copy()).copy(),i=c;else break}this.path.push(t.copy().add(s.mult(3e3)))}render(e){e.moveTo(this.origin.x,this.origin.y);for(let t of this.path)e.lineTo(t.x,t.y)}}class z extends S{constructor(t){super(t);r(this,"numRays");r(this,"lightRays");this.numRays=1e3,this.lightRays=[];for(let s=0;s<this.numRays;s++)this.lightRays.push(new N(this.pos,new n(1,0).rotate(Math.PI*2/this.numRays*s)));this.updateBounds()}updateTransforms(t,s){for(let i of this.lightRays)i.origin=this.pos}updateBounds(){this.bounds=y.fromPoints([this.pos.copy(),this.pos.copy()]),this.bounds.setMinSize(50)}addToWorld(t){for(let s of this.lightRays)t.addLightRay(s)}}const v=[new n(0,-Math.sqrt(3)/3),new n(.5,Math.sqrt(3)/6),new n(-.5,Math.sqrt(3)/6)];class F extends m{constructor(t){super(t);r(this,"size");r(this,"refractiveIndex");this.size=200,this.refractiveIndex=1.5;let s=n.add(this.pos,v[0].copy().mult(this.size).rotate(this.rot)),i=n.add(this.pos,v[1].copy().mult(this.size).rotate(this.rot)),h=n.add(this.pos,v[2].copy().mult(this.size).rotate(this.rot));this.surfaces=[new p(i.copy(),s.copy(),this.refractiveIndex),new p(h.copy(),i.copy(),this.refractiveIndex),new p(s.copy(),h.copy(),this.refractiveIndex)],this.updateBounds()}}class Z{constructor(){r(this,"surfaces",[]);r(this,"lightRays",[]);r(this,"entities",[]);r(this,"worldOffset",n.ZERO);r(this,"worldScale",1);r(this,"selectedEntityIndex",-1);r(this,"isMouseDown",!1);r(this,"lastMousePos",n.ZERO);r(this,"isSelectedEntityBeingDragged",!1)}addSurface(e){this.surfaces.push(e)}addLightRay(e){this.lightRays.push(e)}addEntity(e){this.entities.push(e),e.addToWorld(this)}update(){for(let e of this.lightRays)e.trace(this.surfaces)}handleMouseDown(e){const t=n.sub(e,this.worldOffset).div(this.worldScale);this.selectedEntityIndex=-1;for(let s=0;s<this.entities.length;s++)if(this.entities[s].bounds.has(t)){console.log("Selected entity:",this.entities[s]),this.selectedEntityIndex=s,this.isSelectedEntityBeingDragged=!0;break}this.isMouseDown=!0}handleMouseMove(e){const t=n.sub(e,this.lastMousePos),s=t.copy().div(this.worldScale);if(this.lastMousePos=e,this.isMouseDown){if(this.isSelectedEntityBeingDragged){this.entities[this.selectedEntityIndex].translate(s);return}if(this.selectedEntityIndex===-1){this.worldOffset.add(t);return}}const i=n.sub(e,this.worldOffset).div(this.worldScale);for(let h of this.entities){if(h.bounds.has(i)){h.displayBounds=!0;continue}h.displayBounds=!1}}handleMouseUp(e){this.isMouseDown=!1,this.isSelectedEntityBeingDragged=!1}handleMouseWheel(e){this.worldScale+=e/1e3,this.worldScale=Math.max(Math.min(this.worldScale,1),.1)}render(e){e.save(),e.translate(this.worldOffset.x,this.worldOffset.y),e.scale(this.worldScale,this.worldScale),e.beginPath();for(let t of this.lightRays)t.render(e);e.strokeStyle="rgba(255, 255, 255, 0.2)",e.lineWidth=1,e.stroke();for(let t=0;t<this.entities.length;t++)this.entities[t].render(e,this.selectedEntityIndex==t);e.restore()}}const w=document.getElementById("display"),M=w.getContext("2d");w.width=window.innerWidth;w.height=window.innerHeight;const f=new Z,U=new F(new n(200,150));f.addEntity(U);const Y=new z(new n(700,400));f.addEntity(Y);let X=new W(new n(800,300));f.addEntity(X);let G=new D(new n(500,300));f.addEntity(G);let H=new k(new n(200,500));f.addEntity(H);window.addEventListener("mousedown",a=>{f.handleMouseDown(new n(a.clientX,a.clientY))});window.addEventListener("mousemove",a=>{f.handleMouseMove(new n(a.clientX,a.clientY))});window.addEventListener("mouseup",a=>{f.handleMouseUp(new n(a.clientX,a.clientY))});window.addEventListener("wheel",a=>{f.handleMouseWheel(-a.deltaY)});function O(){requestAnimationFrame(O),M.fillStyle="black",M.fillRect(0,0,w.width,w.height),f.update(),f.render(M)}O();
