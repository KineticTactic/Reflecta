var L=Object.defineProperty;var D=(a,t,e)=>t in a?L(a,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):a[t]=e;var r=(a,t,e)=>(D(a,typeof t!="symbol"?t+"":t,e),e);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const h of i)if(h.type==="childList")for(const o of h.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&s(o)}).observe(document,{childList:!0,subtree:!0});function e(i){const h={};return i.integrity&&(h.integrity=i.integrity),i.referrerPolicy&&(h.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?h.credentials="include":i.crossOrigin==="anonymous"?h.credentials="omit":h.credentials="same-origin",h}function s(i){if(i.ep)return;i.ep=!0;const h=e(i);fetch(i.href,h)}})();const l=class{constructor(t,e){r(this,"x");r(this,"y");this.x=t,this.y=e}add(t,e){return t instanceof l?(this.x+=t.x,this.y+=t.y):e?(this.x+=t,this.y+=e):(this.x+=t,this.y+=t),this}static add(t,e){return new l(t.x+e.x,t.y+e.y)}mult(t,e){return t instanceof l?(this.x*=t.x,this.y*=t.y):e?(this.x*=t,this.y*=e):(this.x*=t,this.y*=t),this}static mult(t,e){return e instanceof l?new l(t.x*e.x,t.y*e.y):new l(t.x*e,t.y*e)}sub(t,e){return t instanceof l?(this.x-=t.x,this.y-=t.y):e?(this.x-=t,this.y-=e):(this.x-=t,this.y-=t),this}static sub(t,e){return new l(t.x-e.x,t.y-e.y)}div(t,e){return t instanceof l?(this.x/=t.x,this.y/=t.y):e?(this.x/=t,this.y/=e):(this.x/=t,this.y/=t),this}static div(t,e){return new l(t.x/e.x,t.y/e.y)}set(t,e){return t instanceof l?(this.x=t.x,this.y=t.y):e?(this.x=t,this.y=e):(this.x=t,this.y=t),this}mag(){return Math.sqrt(this.x*this.x+this.y*this.y)}static mag(t){return Math.sqrt(t.x*t.x+t.y*t.y)}magSq(){return this.x*this.x+this.y*this.y}static magSq(t){return t.x*t.x+t.y*t.y}setMag(t){let e=this.mag();return this.x*=t/e,this.y*=t/e,this}normalize(){return this.setMag(1),this}limit(t){return this.mag()>t&&this.setMag(t),this}heading(){return Math.atan2(this.y,this.x)}rotate(t){let e=Math.cos(t),s=Math.sin(t),i=e*this.x-s*this.y,h=e*this.y+s*this.x;return this.x=i,this.y=h,this}rotateAboutAxis(t,e){return this.sub(e).rotate(t).add(e),this}dot(t){return t.x*this.x+t.y*this.y}static dot(t,e){return t.x*e.x+t.y*e.y}cross(t){return this.x*t.y-this.y*t.x}static cross(t,e){return t.x*e.y-t.y*e.x}dist(t){return Math.sqrt(Math.pow(this.x-t.x,2)+Math.pow(this.y-t.y,2))}static dist(t,e){return Math.sqrt(Math.pow(e.x-t.x,2)+Math.pow(e.y-t.y,2))}lerp(t,e){let s=t.x-this.x,i=t.y-this.y;return this.x+=e*s,this.y+=e*i,this}static angleBetween(t,e){return Math.atan2(t.x*e.y-t.y*e.x,t.x*e.x+t.y*e.y)}copy(){return new l(this.x,this.y)}};let n=l;r(n,"zero",()=>new l(0,0)),r(n,"up",()=>new l(0,-1)),r(n,"down",()=>new l(0,1)),r(n,"left",()=>new l(-1,0)),r(n,"right",()=>new l(1,0));function q(a,t){return n.sub(a,t.copy().mult(2*n.dot(a,t)/t.magSq()))}function C(a,t,e,s){let i=Math.atan2(a.y,a.x)-Math.atan2(t.y,t.x);if(i>Math.PI&&(i=-(Math.PI*2-i)),i<-Math.PI&&(i=Math.PI*2+i),i>Math.PI/2||i<-Math.PI/2){let h=Math.PI-i,o=Math.asin(Math.sin(h)/e),c=h-o;return a.copy().rotate(c)}else{let h=i;if(h>s||h<-s)return q(a,t);let o=Math.asin(Math.sin(h)*e),c=h-o;return a.copy().rotate(-c)}}function z(a,t,e,s){let i=n.sub(t,a),h=n.sub(a,e),o=n.cross(s,i),c=n.cross(h,i)/o,u=n.cross(h,s)/o;return c>=0&&u>=0&&u<=1?n.add(e,s.mult(c)):null}function T(a,t,e,s=.1){let i=n.sub(a,e).mag(),h=n.sub(t,e).mag(),o=n.sub(t,a).mag();return Math.abs(i+h-o)<s}function F(a,t,e){let s=n.sub(e,a),i=n.dot(s,t)/t.magSq();return n.add(a,t.mult(i))}class x{constructor(t,e){r(this,"start");r(this,"end");this.start=t,this.end=e}has(t){return!(t.x<this.start.x||t.x>this.end.x||t.y<this.start.y||t.y>this.end.y)}setMinSize(t){if(Math.abs(this.start.x-this.end.x)<t){let e=t-Math.abs(this.start.x-this.end.x);this.start.x-=e/2,this.end.x+=e/2}if(Math.abs(this.start.y-this.end.y)<t){let e=t-Math.abs(this.start.y-this.end.y);this.start.y-=e/2,this.end.y+=e/2}}render(t,e="#8424b9",s=1){t.strokeStyle=e,t.lineWidth=s,t.strokeRect(this.start.x,this.start.y,this.end.x-this.start.x,this.end.y-this.start.y)}static fromPoints(t){let e=t[0].copy(),s=t[0].copy();for(let i of t)i.x<e.x?e.x=i.x:i.x>s.x&&(s.x=i.x),i.y<e.y?e.y=i.y:i.y>s.y&&(s.y=i.y);return new x(e,s)}static fromAABBs(t){const e=[];for(let s of t)e.push(s.start,s.end);return x.fromPoints(e)}}class O{}class W extends O{constructor(e,s,i,h){super();r(this,"center");r(this,"radius");r(this,"facing");r(this,"span");r(this,"canIntersectTwice",!0);this.center=e,this.radius=s,this.facing=i,this.span=h}intersects(e,s){let i=F(e.copy(),s.copy(),this.center),h=n.sub(i,this.center).magSq();if(h>this.radius*this.radius)return null;let o=Math.sqrt(this.radius*this.radius-h);if(n.sub(e,i).magSq()>o*o){let u=n.sub(i,s.copy().normalize().mult(o));if(!(Math.abs(n.angleBetween(n.sub(u,e),s))>.2)){let f=n.sub(u,this.center);if(Math.abs(n.angleBetween(f,this.facing))<=this.span/2&&e.dist(u)>.01)return u}}let c=n.add(i,s.copy().normalize().mult(o));if(!(Math.abs(n.angleBetween(n.sub(c,e),s))>.2)){let u=n.sub(c,this.center);if(Math.abs(n.angleBetween(u,this.facing))<=this.span/2&&e.dist(c)>.01)return c}return null}translate(e){this.center.add(e)}rotateAboutAxis(e,s){this.center.rotateAboutAxis(e,s),this.facing.rotate(e)}calculateAABB(){const e=[n.up(),n.down(),n.left(),n.right()],s=[];for(const i of e)Math.abs(n.angleBetween(i,this.facing))<this.span/2&&s.push(n.add(this.center,n.mult(i,this.radius)));return s.push(n.add(this.center,n.mult(this.facing.copy().rotate(this.span/2),this.radius))),s.push(n.add(this.center,n.mult(this.facing.copy().rotate(-this.span/2),this.radius))),x.fromPoints(s)}render(e,s="#ffffff"){let i=this.facing.heading()-this.span/2,h=this.facing.heading()+this.span/2;e.beginPath(),e.strokeStyle=s,e.lineWidth=2,e.arc(this.center.x,this.center.y,this.radius,i,h),e.stroke()}}class w extends W{constructor(e,s,i,h,o,c=1){super(e,s,i,h);r(this,"refractiveIndex");r(this,"criticalAngle");r(this,"normal");this.refractiveIndex=o,this.criticalAngle=Math.asin(1/this.refractiveIndex),this.normal=c}handle(e,s){let i=n.sub(e,this.center).normalize().mult(this.normal);return C(s,i,this.refractiveIndex,this.criticalAngle)}}class V extends O{constructor(e,s){super();r(this,"v1");r(this,"v2");r(this,"normal",new n(0,0));r(this,"canIntersectTwice",!1);this.v1=e,this.v2=s,this.calculateNormal()}calculateNormal(){this.normal=n.sub(this.v2,this.v1).rotate(Math.PI/2).normalize()}setVertices(e,s){this.v1=e.copy(),this.v2=s.copy(),this.calculateNormal()}translate(e){this.v1.add(e),this.v2.add(e),this.calculateNormal()}rotateAboutAxis(e,s){this.v1.rotateAboutAxis(e,s),this.v2.rotateAboutAxis(e,s),this.calculateNormal()}intersects(e,s){return z(this.v1.copy(),this.v2.copy(),e.copy(),s.copy())}intersectsPoint(e,s=.1){return T(this.v1.copy(),this.v2.copy(),e.copy(),s)}calculateAABB(){return x.fromPoints([this.v1,this.v2])}render(e,s="#ffffff"){e.strokeStyle=s,e.lineWidth=2,e.beginPath(),e.moveTo(this.v1.x,this.v1.y),e.lineTo(this.v2.x,this.v2.y),e.stroke()}}class g extends V{constructor(e,s,i){super(e,s);r(this,"refractiveIndex");r(this,"criticalAngle");this.refractiveIndex=i,this.criticalAngle=Math.asin(1/this.refractiveIndex)}handle(e,s){return C(s,this.normal,this.refractiveIndex,this.criticalAngle)}}var d=(a=>(a.Number="number",a.String="text",a.Boolean="checkbox",a.Color="color",a.Vector="vector",a))(d||{});class S{constructor(t,e){r(this,"pos");r(this,"rot");r(this,"bounds");r(this,"name");r(this,"color","#ffffff");r(this,"displayBounds",!1);r(this,"attributes");r(this,"surfaces",[]);r(this,"lightRays",[]);this.pos=t,this.rot=0,this.name=e,this.bounds=new x(n.zero(),n.zero()),this.attributes=[{name:"color",type:d.Color},{name:"displayBounds",type:d.Boolean},{name:"pos",type:d.Vector},{name:"rot",type:d.Number}]}setPosition(t){const e=n.sub(t,this.pos);this.pos=t,this.updateTransforms(e,0),this.updateBounds()}setRotation(t){const e=t-this.rot;this.rot=t,this.updateTransforms(n.zero(),e),this.updateBounds()}translate(t){this.pos.add(t),this.updateTransforms(t,0),this.updateBounds()}rotate(t){this.rot+=t,this.updateTransforms(n.zero(),t),this.updateBounds()}updateTransforms(t,e){}updateBounds(){}updateAttribute(t,e){switch(console.log("updating attribute",t,e),t){case"pos":this.setPosition(e);break;case"rot":this.setRotation(e);break;case"color":this.color=e;break;case"displayBounds":this.displayBounds=e;break}}render(t,e){this.displayBounds&&this.bounds.render(t),e&&this.bounds.render(t,"#8424b9",2)}}class M extends S{constructor(t,e){super(t,e)}updateTransforms(t,e){for(let s of this.surfaces)s.translate(t),s.rotateAboutAxis(e,this.pos.copy())}updateBounds(){let t=[];for(let e of this.surfaces){const s=e.calculateAABB();t.push(s)}this.bounds=x.fromAABBs(t)}render(t,e){for(let s of this.surfaces)s.render(t,this.color);super.render(t,e)}}class k extends M{constructor(e){super(e,"Concave Lens");r(this,"span");r(this,"radiusOfCurvature");r(this,"thickness");r(this,"refractiveIndex");this.span=.4,this.radiusOfCurvature=500,this.thickness=4,this.refractiveIndex=1.666,this.init(),this.attributes.push({name:"span",type:d.Number,min:0,max:1e3}),this.attributes.push({name:"radiusOfCurvature",type:d.Number,min:0,max:1e3}),this.attributes.push({name:"thickness",type:d.Number,min:0,max:1e3}),this.attributes.push({name:"refractiveIndex",type:d.Number,min:.1,max:10})}init(){let e=this.radiusOfCurvature+this.thickness/2,s=this.radiusOfCurvature*Math.sin(this.span/2),i=this.radiusOfCurvature-Math.cos(this.span/2)*this.radiusOfCurvature+this.thickness/2;this.surfaces=[new w(new n(this.pos.x-e,this.pos.y),this.radiusOfCurvature,n.right(),this.span,this.refractiveIndex,-1),new w(new n(this.pos.x+e,this.pos.y),this.radiusOfCurvature,n.left(),this.span,this.refractiveIndex,-1),new g(new n(this.pos.x-i,this.pos.y+s),new n(this.pos.x+i,this.pos.y+s),this.refractiveIndex),new g(new n(this.pos.x+i,this.pos.y-s),new n(this.pos.x-i,this.pos.y-s),this.refractiveIndex)],this.updateBounds()}updateAttribute(e,s){switch(e){case"span":this.span=s,this.init();break;case"radiusOfCurvature":this.radiusOfCurvature=s,this.init();break;case"thickness":this.thickness=s,this.init();break;case"refractiveIndex":this.refractiveIndex=s,this.surfaces.forEach(i=>{i.refractiveIndex=this.refractiveIndex});break}}}class R extends M{constructor(e){super(e,"Convex Lens");r(this,"span");r(this,"radiusOfCurvature");r(this,"refractiveIndex");this.span=1,this.radiusOfCurvature=200,this.refractiveIndex=1.666,this.init(),this.attributes.push({name:"span",type:d.Number,min:0,max:1e3}),this.attributes.push({name:"radiusOfCurvature",type:d.Number,min:0,max:1e3}),this.attributes.push({name:"refractiveIndex",type:d.Number,min:.1,max:10})}init(){let e=this.radiusOfCurvature*Math.sin(this.span/2),s=Math.sqrt(this.radiusOfCurvature**2-e**2);this.surfaces=[new w(new n(this.pos.x-s,this.pos.y),this.radiusOfCurvature,n.right(),this.span,this.refractiveIndex),new w(new n(this.pos.x+s,this.pos.y),this.radiusOfCurvature,n.left(),this.span,this.refractiveIndex)],this.updateBounds()}updateAttribute(e,s){switch(e){case"span":this.span=s,this.init();break;case"radiusOfCurvature":this.radiusOfCurvature=s,this.init();break;case"refractiveIndex":this.refractiveIndex=s,this.surfaces.forEach(i=>{i.refractiveIndex=this.refractiveIndex});break}}}class Y extends M{constructor(e){super(e,"Glass Sphere");r(this,"radius");r(this,"refractiveIndex");this.radius=100,this.refractiveIndex=1.666,this.init(),this.attributes.push({name:"radius",type:d.Number,min:0,max:1e3}),this.attributes.push({name:"refractiveIndex",type:d.Number,min:.1,max:10})}init(){this.surfaces=[new w(this.pos.copy(),this.radius,n.right(),Math.PI*2,this.refractiveIndex)],this.updateBounds()}updateAttribute(e,s){switch(e){case"radius":this.radius=s,this.init();break;case"refractiveIndex":this.refractiveIndex=s,this.surfaces[0].refractiveIndex=this.refractiveIndex;break}}}class U{constructor(t,e){r(this,"origin");r(this,"dir");r(this,"path");this.origin=t,this.dir=e.copy(),this.path=[this.origin]}trace(t){this.path=[this.origin];let e=this.path[0],s=this.dir.copy(),i=null;for(let h=0;h<50;h++){let o=null,c=null,u=1/0;for(let f=0;f<t.length;f++){if(f===i&&!t[f].canIntersectTwice)continue;let y=t[f].intersects(e.copy(),s.copy());if(!y)continue;let b=n.sub(y,e).magSq();b<u&&(o=y,u=b,c=f)}if(o&&c!==null)this.path.push(o),e=o,s=t[c].handle(o.copy(),s.copy()).copy(),i=c;else break}this.path.push(e.copy().add(s.mult(3e3)))}render(t){t.moveTo(this.origin.x,this.origin.y);for(let e of this.path)t.lineTo(e.x,e.y)}}class X extends S{constructor(e){super(e,"Point Light");r(this,"numRays");this.numRays=1e3,this.init(),this.attributes.push({name:"numRays",type:d.Number,min:0,max:1e4})}init(){this.lightRays=[];for(let e=0;e<this.numRays;e++)this.lightRays.push(new U(this.pos,new n(1,0).rotate(Math.PI*2/this.numRays*e)));this.updateBounds()}updateTransforms(e,s){for(let i of this.lightRays)i.origin=this.pos}updateBounds(){this.bounds=x.fromPoints([this.pos.copy(),this.pos.copy()]),this.bounds.setMinSize(50)}updateAttribute(e,s){switch(super.updateAttribute(e,s),e){case"numRays":this.numRays=s,this.init();break}}}const P=[new n(0,-Math.sqrt(3)/3),new n(.5,Math.sqrt(3)/6),new n(-.5,Math.sqrt(3)/6)];class $ extends M{constructor(e){super(e,"Prism");r(this,"size");r(this,"refractiveIndex");this.size=200,this.refractiveIndex=1.5,this.init(),this.attributes.push({name:"size",type:d.Number,min:0,max:1e3}),this.attributes.push({name:"refractiveIndex",type:d.Number,min:.1,max:10})}init(){let e=n.add(this.pos,P[0].copy().mult(this.size).rotate(this.rot)),s=n.add(this.pos,P[1].copy().mult(this.size).rotate(this.rot)),i=n.add(this.pos,P[2].copy().mult(this.size).rotate(this.rot));this.surfaces=[new g(s.copy(),e.copy(),this.refractiveIndex),new g(i.copy(),s.copy(),this.refractiveIndex),new g(e.copy(),i.copy(),this.refractiveIndex)],this.updateBounds()}updateAttribute(e,s){switch(super.updateAttribute(e,s),e){case"size":this.size=s,this.init();break;case"refractiveIndex":this.refractiveIndex=s;for(const i of this.surfaces)i.refractiveIndex=this.refractiveIndex;break}}}const G=[k,R];class H{constructor(){r(this,"entityAddDiv");r(this,"entityAttributesDiv");r(this,"selectedEntity",null);console.log(G),this.entityAddDiv=document.getElementById("entity-creation"),this.entityAttributesDiv=document.getElementById("entity-attributes")}selectEntity(t){this.selectedEntity=t,this.entityAttributesDiv.innerHTML=t.name+"<br/>",this.createEntityAttributesDOM(t)}createEntityAttributesDOM(t){console.log(t.attributes);for(const e of t.attributes){const s=this.createAttributeDOM(t,e);this.entityAttributesDiv.appendChild(s)}}createAttributeDOM(t,e){console.log(this.selectEntity);const s=document.createElement("div");s.className="attribute";const i=document.createElement("label");switch(i.innerText=e.name,s.appendChild(i),e.type){case d.Vector:const h=t[e.name];console.log(e.name);let o;o=document.createElement("input"),o.type="number",o.value=h.x.toString();const c=document.createElement("div");c.className="input-container vector-x",c.appendChild(o);let u;u=document.createElement("input"),u.type="number",u.value=h.y.toString();const f=document.createElement("div");f.className="input-container vector-y",f.appendChild(u),s.appendChild(c),s.appendChild(f),o.addEventListener("input",v=>{const A=new n(parseFloat(v.target.value),parseFloat(u.value));t.updateAttribute(e.name,A)}),u.addEventListener("input",v=>{const A=new n(parseFloat(v.target.value),parseFloat(u.value));t.updateAttribute(e.name,A)});break;case d.Boolean:const y=document.createElement("input");y.type="checkbox",y.checked=t[e.name];const b=document.createElement("div");b.className="input-container",b.appendChild(y),s.appendChild(b),y.addEventListener("input",v=>{t.updateAttribute(e.name,v.target.checked)});break;default:const I=document.createElement("input");I.type=e.type,I.value=t[e.name].toString();const E=document.createElement("div");E.className="input-container",E.appendChild(I),s.appendChild(E),I.addEventListener("input",v=>{t.updateAttribute(e.name,v.target.value)});break}return s}}class K{constructor(){r(this,"surfaces",[]);r(this,"lightRays",[]);r(this,"entities",[]);r(this,"worldOffset",n.zero());r(this,"worldScale",1);r(this,"selectedEntityIndex",-1);r(this,"isMouseDown",!1);r(this,"lastMousePos",n.zero());r(this,"isSelectedEntityBeingDragged",!1);r(this,"ui",new H)}addEntity(t){this.entities.push(t)}update(){this.surfaces=this.entities.map(t=>t.surfaces).flat(),this.lightRays=this.entities.map(t=>t.lightRays).flat();for(let t of this.lightRays)t.trace(this.surfaces)}handleMouseDown(t){const e=n.sub(t,this.worldOffset).div(this.worldScale);this.selectedEntityIndex=-1;for(let s=0;s<this.entities.length;s++)if(this.entities[s].bounds.has(e)){console.log("Selected entity:",this.entities[s]),this.selectedEntityIndex=s,this.isSelectedEntityBeingDragged=!0,this.ui.selectEntity(this.entities[s]);break}this.isMouseDown=!0}handleMouseMove(t){const e=n.sub(t,this.lastMousePos),s=e.copy().div(this.worldScale);if(this.lastMousePos=t,this.isMouseDown){if(this.isSelectedEntityBeingDragged){this.entities[this.selectedEntityIndex].translate(s);return}if(this.selectedEntityIndex===-1){this.worldOffset.add(e);return}}const i=n.sub(t,this.worldOffset).div(this.worldScale);for(let h of this.entities){if(h.bounds.has(i)){h.displayBounds=!0;continue}h.displayBounds=!1}}handleMouseUp(t){this.isMouseDown=!1,this.isSelectedEntityBeingDragged=!1}handleMouseWheel(t){this.worldScale+=t/1e3}render(t){t.save(),t.translate(this.worldOffset.x,this.worldOffset.y),t.scale(this.worldScale,this.worldScale),t.beginPath();for(let s of this.lightRays)s.render(t);const e=50;t.strokeStyle=`rgba(${e}, ${e}, ${e}, 1)`,t.lineWidth=1,t.globalCompositeOperation="lighter",t.lineCap="butt",t.stroke(),t.closePath();for(let s=0;s<this.entities.length;s++)this.entities[s].render(t,this.selectedEntityIndex==s);t.restore()}}const m=document.getElementById("display"),B=m.getContext("2d");m.width=window.innerWidth;m.height=window.innerHeight;const p=new K,Q=new $(new n(200,150));p.addEntity(Q);const j=new X(new n(700,400));p.addEntity(j);let J=new R(new n(800,300));p.addEntity(J);let Z=new k(new n(500,300));p.addEntity(Z);let _=new Y(new n(200,500));p.addEntity(_);m.addEventListener("mousedown",a=>{p.handleMouseDown(new n(a.clientX,a.clientY))});m.addEventListener("mousemove",a=>{p.handleMouseMove(new n(a.clientX,a.clientY))});m.addEventListener("mouseup",a=>{p.handleMouseUp(new n(a.clientX,a.clientY))});m.addEventListener("wheel",a=>{p.handleMouseWheel(-a.deltaY)});p.selectedEntityIndex=1;p.ui.selectEntity(p.entities[1]);function N(){requestAnimationFrame(N),B.fillStyle="black",B.fillRect(0,0,m.width,m.height),p.update(),p.render(B)}N();
