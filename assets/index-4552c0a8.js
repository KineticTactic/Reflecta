var v=Object.defineProperty;var M=(o,t,e)=>t in o?v(o,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):o[t]=e;var h=(o,t,e)=>(M(o,typeof t!="symbol"?t+"":t,e),e);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const n of i)if(n.type==="childList")for(const l of n.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&s(l)}).observe(document,{childList:!0,subtree:!0});function e(i){const n={};return i.integrity&&(n.integrity=i.integrity),i.referrerPolicy&&(n.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?n.credentials="include":i.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function s(i){if(i.ep)return;i.ep=!0;const n=e(i);fetch(i.href,n)}})();class m{constructor(t){h(this,"pos");this.pos=t}addToWorld(t){}render(t){}}class r{constructor(t,e){h(this,"x");h(this,"y");this.x=t,this.y=e}add(t,e){return t instanceof r?(this.x+=t.x,this.y+=t.y):e?(this.x+=t,this.y+=e):(this.x+=t,this.y+=t),this}static add(t,e){return new r(t.x+e.x,t.y+e.y)}mult(t,e){return t instanceof r?(this.x*=t.x,this.y*=t.y):e?(this.x*=t,this.y*=e):(this.x*=t,this.y*=t),this}static mult(t,e){return new r(t.x*e.x,t.y*e.y)}sub(t,e){return t instanceof r?(this.x-=t.x,this.y-=t.y):e?(this.x-=t,this.y-=e):(this.x-=t,this.y-=t),this}static sub(t,e){return new r(t.x-e.x,t.y-e.y)}div(t,e){return t instanceof r?(this.x/=t.x,this.y/=t.y):e?(this.x/=t,this.y/=e):(this.x/=t,this.y/=t),this}static div(t,e){return new r(t.x/e.x,t.y/e.y)}set(t,e){return t instanceof r?(this.x=t.x,this.y=t.y):e?(this.x=t,this.y=e):(this.x=t,this.y=t),this}mag(){return Math.sqrt(this.x*this.x+this.y*this.y)}static mag(t){return Math.sqrt(t.x*t.x+t.y*t.y)}magSq(){return this.x*this.x+this.y*this.y}static magSq(t){return t.x*t.x+t.y*t.y}setMag(t){let e=this.mag();return this.x*=t/e,this.y*=t/e,this}normalize(){return this.setMag(1),this}limit(t){return this.mag()>t&&this.setMag(t),this}heading(){return Math.atan2(this.y,this.x)}rotate(t){let e=Math.cos(t),s=Math.sin(t),i=e*this.x-s*this.y,n=e*this.y+s*this.x;return this.x=i,this.y=n,this}dot(t){return t.x*this.x+t.y*this.y}static dot(t,e){return t.x*e.x+t.y*e.y}cross(t){return this.x*t.y-this.y*t.x}static cross(t,e){return t.x*e.y-t.y*e.x}dist(t){return Math.sqrt(Math.pow(this.x-t.x,2)+Math.pow(this.y-t.y,2))}static dist(t,e){return Math.sqrt(Math.pow(e.x-t.x,2)+Math.pow(e.y-t.y,2))}lerp(t,e){let s=t.x-this.x,i=t.y-this.y;return this.x+=e*s,this.y+=e*i,this}copy(){return new r(this.x,this.y)}}class I{constructor(t,e){h(this,"origin");h(this,"dir");h(this,"path");this.origin=t,this.dir=e.copy(),this.path=[this.origin]}trace(t){this.path=[this.origin];let e=this.path[0],s=this.dir.copy(),i=null;for(let n=0;n<500;n++){let l=null,a=null,d=1/0;for(let c=0;c<t.length;c++){let f=t[c].intersects(e,s);if(!f)continue;let p=r.sub(f,e).magSq();p<d&&c!==i&&(l=f,d=p,a=c)}if(l&&a)this.path.push(l),e=l,s=t[a].handle(l,s).copy(),i=a;else break}this.path.push(e.copy().add(s.mult(2e3)))}render(t){t.beginPath(),t.moveTo(this.origin.x,this.origin.y);for(let e of this.path)t.lineTo(e.x,e.y);t.strokeStyle="rgba(255, 255, 255, 0.5)",t.stroke()}}class R extends m{constructor(e){super(e);h(this,"size");h(this,"numRays");h(this,"lightRays");this.size=100,this.numRays=10,this.lightRays=[];for(let s=-this.size/2;s<=this.size/2;s+=this.size/this.numRays)this.lightRays.push(new I(r.add(this.pos,new r(0,s)),new r(1,0)))}addToWorld(e){for(let s of this.lightRays)e.addLightRay(s)}render(e){for(let s of this.lightRays)s.render(e)}}function P(o,t,e,s){let i=r.sub(t,o),n=r.sub(o,e),l=r.cross(s,i),a=r.cross(n,i)/l,d=r.cross(n,s)/l;return a>=0&&d>=0&&d<=1?r.add(e,s.mult(a)):null}class q{constructor(t,e){h(this,"v1");h(this,"v2");h(this,"normal",new r(0,0));this.v1=t,this.v2=e,this.calculateNormal()}handle(t,e){throw Error("Not implemented")}calculateNormal(){this.normal=r.sub(this.v2,this.v1).rotate(Math.PI/2).normalize()}intersects(t,e){return P(this.v1.copy(),this.v2.copy(),t.copy(),e.copy())}render(t){t.strokeStyle="white",t.lineWidth=2,t.beginPath(),t.moveTo(this.v1.x,this.v1.y),t.lineTo(this.v2.x,this.v2.y),t.stroke();const e=r.add(this.v1,this.v2).mult(.5);t.strokeStyle="red",t.lineWidth=1,t.beginPath(),t.moveTo(e.x,e.y),t.lineTo(e.x+this.normal.x*50,e.y+this.normal.y*50),t.stroke()}}class x extends q{constructor(e,s,i){super(e,s);h(this,"refractiveIndex");h(this,"criticalAngle");this.refractiveIndex=i,this.criticalAngle=Math.asin(1/this.refractiveIndex)}handle(e,s){let i=Math.atan2(s.y,s.x)-Math.atan2(this.normal.y,this.normal.x);if(i>Math.PI/2||i<-Math.PI/2){let n=Math.PI-i,l=Math.asin(Math.sin(n)/this.refractiveIndex),a=n-l;return s.copy().rotate(a)}else{let n=i;if(n>this.criticalAngle||n<-this.criticalAngle)return r.sub(s,this.normal.copy().mult(2*r.dot(s,this.normal)/this.normal.magSq()));let l=Math.asin(Math.sin(n)*this.refractiveIndex),a=n-l;return s.copy().rotate(-a)}}}class z extends m{constructor(e){super(e);h(this,"size");h(this,"refractiveIndex");h(this,"surfaces");this.size=200,this.refractiveIndex=1.5;let s=r.add(this.pos,new r(0,-Math.sqrt(3)*this.size/3)),i=r.add(this.pos,new r(this.size/2,Math.sqrt(3)*this.size/6)),n=r.add(this.pos,new r(-this.size/2,Math.sqrt(3)*this.size/6));this.surfaces=[new x(i,s,this.refractiveIndex),new x(n,i,this.refractiveIndex),new x(s,n,this.refractiveIndex)]}addToWorld(e){for(let s of this.surfaces)e.addSurface(s)}render(e){for(let s of this.surfaces)s.render(e)}}class S{constructor(){h(this,"surfaces",[]);h(this,"lightRays",[]);h(this,"entities",[])}addSurface(t){this.surfaces.push(t)}addLightRay(t){this.lightRays.push(t)}addEntity(t){this.entities.push(t),t.addToWorld(this)}update(){for(let t of this.lightRays)t.trace(this.surfaces)}render(t){for(let e of this.lightRays)e.render(t);for(let e of this.entities)e.render(t)}}const u=document.getElementById("display"),g=u.getContext("2d");u.width=window.innerWidth;u.height=window.innerHeight;const y=new S;y.addEntity(new z(new r(600,300)));y.addEntity(new R(new r(300,300)));function w(){requestAnimationFrame(w),g.fillStyle="black",g.fillRect(0,0,u.width,u.height),y.update(),y.render(g)}w();
